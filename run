#!/usr/bin/env bash
# run — launch any app in the shared toolbox container
#
# Usage:
#   ./run <app-name> [args...]
#   TOOLBOX_VARIANT=gpu ./run <app-name> [args...]
#
# Examples:
#   ./run voice-split --url "https://www.youtube.com/watch?v=XXXX" --clips 5 --length 30
#   ./run voice-split --help
#   TOOLBOX_VARIANT=gpu ./run voice-synth speak --voice my-voice --text "Hello"
#
# TOOLBOX_VARIANT:
#   (unset / "cpu")  — use docker-compose.yml only  (CPU image, default)
#   "gpu"            — overlay docker-compose.gpu.yml (CUDA image + GPU passthrough)
#                      Requires:  make build-gpu  +  NVIDIA Container Toolkit
#                      See docker-compose.gpu.yml for full GPU setup instructions.
#
# Each app lives in apps/<app-name>/<app-name>.py
# Output goes to ./work/ by default (mounted as /work inside the container)
# Cache is shared across all apps in ./cache/ (mounted as /cache)

set -euo pipefail

APP=${1:-}
if [[ -z "$APP" ]]; then
  echo "Usage: ./run <app-name> [args...]"
  echo ""
  echo "  TOOLBOX_VARIANT=gpu ./run <app-name> [args...]   (GPU mode)"
  echo ""
  echo "Available apps:"
  for d in "$(dirname "$0")/apps"/*/; do
    echo "  $(basename "$d")"
  done
  exit 1
fi
shift

SCRIPT="apps/${APP}/${APP}.py"

if [[ ! -f "$(dirname "$0")/${SCRIPT}" ]]; then
  echo "Error: no script found at ${SCRIPT}"
  exit 1
fi

# ── compose file selection ─────────────────────────────────────────────────────
# TOOLBOX_VARIANT=gpu adds the GPU overlay; everything else uses CPU-only defaults.
COMPOSE_FILES="-f docker-compose.yml"
if [[ "${TOOLBOX_VARIANT:-}" == "gpu" ]]; then
  COMPOSE_FILES="$COMPOSE_FILES -f docker-compose.gpu.yml"
fi

exec docker compose $COMPOSE_FILES run --rm toolbox python "${SCRIPT}" "$@"
